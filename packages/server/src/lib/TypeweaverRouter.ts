// NOTE: The @generated header below is for the copy that ships to user projects.
// This file IS the source of truth — edit it here.
/**
 * This file was automatically generated by typeweaver.
 * DO NOT EDIT. Instead, modify the source definition file and generate again.
 *
 * @generated by @rexeus/typeweaver
 */

import type { HttpMethod, IRequestValidator } from "@rexeus/typeweaver-core";
import type { RequestHandler } from "./RequestHandler";
import type {
  HttpResponseErrorHandler,
  RouteDefinition,
  RouterErrorConfig,
  UnknownErrorHandler,
  ValidationErrorHandler,
} from "./Router";

/**
 * Configuration options for TypeweaverRouter instances.
 *
 * @template RequestHandlers - Object type containing all handler methods for this router
 */
export type TypeweaverRouterOptions<
  RequestHandlers extends Record<string, RequestHandler>,
> = {
  /**
   * Request handler methods for each operation.
   * Each handler receives a validated request and the server context.
   */
  readonly requestHandlers: RequestHandlers;

  /**
   * Enable request validation using generated validators.
   * When false, requests are passed through without validation.
   * @default true
   */
  readonly validateRequests?: boolean;

  /**
   * Configure handling of HttpResponse errors thrown by handlers.
   * - `true`: Use default handler (returns the error as response)
   * - `false`: Disable this handler (errors fall through to the unknown error handler)
   * - `function`: Use custom error handler
   * @default true
   */
  readonly handleHttpResponseErrors?: HttpResponseErrorHandler | boolean;

  /**
   * Configure handling of request validation errors.
   * - `true`: Use default handler (400 with error details)
   * - `false`: Disable this handler (errors fall through to the unknown error handler)
   * - `function`: Use custom error handler
   * @default true
   */
  readonly handleValidationErrors?: ValidationErrorHandler | boolean;

  /**
   * Configure handling of unknown errors.
   * - `true`: Use default handler (500 Internal Server Error)
   * - `false`: Disable this handler (errors bubble up to the safety net)
   * - `function`: Use custom error handler
   * @default true
   */
  readonly handleUnknownErrors?: UnknownErrorHandler | boolean;
};

/**
 * Abstract base class for typeweaver-generated routers.
 *
 * Each generated router (e.g., `AccountRouter`, `TodoRouter`) extends this class
 * and registers its routes in the constructor via `this.route(...)`.
 *
 * The router does **not** handle HTTP directly — it collects route definitions
 * that are mounted onto a `TypeweaverApp` via `app.route(...)`.
 *
 * All types are in typeweaver's native `IHttpRequest`/`IHttpResponse` format.
 * No framework-specific types are involved.
 *
 * @template RequestHandlers - Object type containing typed handler methods
 */
export abstract class TypeweaverRouter<
  RequestHandlers extends Record<string, RequestHandler>,
> {
  protected readonly requestHandlers: RequestHandlers;
  private readonly routes: RouteDefinition[] = [];
  private readonly errorConfig: RouterErrorConfig;

  public constructor(options: TypeweaverRouterOptions<RequestHandlers>) {
    const {
      requestHandlers,
      validateRequests = true,
      handleHttpResponseErrors = true,
      handleValidationErrors = true,
      handleUnknownErrors = true,
    } = options;

    this.requestHandlers = requestHandlers;

    this.errorConfig = {
      validateRequests,
      handleHttpResponseErrors,
      handleValidationErrors,
      handleUnknownErrors,
    };
  }

  /**
   * Register a route. Called by generated subclasses in their constructor.
   *
   * @param method - HTTP method (GET, POST, PUT, DELETE, etc.)
   * @param path - Path pattern with `:param` placeholders
   * @param validator - Request validator for this operation
   * @param handler - Type-safe request handler
   */
  protected route(
    method: HttpMethod,
    path: string,
    validator: IRequestValidator,
    handler: RequestHandler
  ): void {
    this.routes.push({
      method,
      path,
      validator,
      handler,
      routerConfig: this.errorConfig,
    });
  }

  /**
   * Returns all registered routes. Used by `TypeweaverApp` when mounting via `app.route(...)`.
   */
  public getRoutes(): readonly RouteDefinition[] {
    return this.routes;
  }
}
