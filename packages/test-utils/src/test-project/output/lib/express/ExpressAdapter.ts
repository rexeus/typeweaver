/**
 * This file was automatically generated by typeweaver.
 * DO NOT EDIT. Instead, modify the source definition file and generate again.
 *
 * @generated by @rexeus/typeweaver
 */

import type {
  HttpMethod,
  IHttpBody,
  IHttpHeader,
  IHttpQuery,
  IHttpRequest,
  IHttpResponse,
} from "@rexeus/typeweaver-core";
import { HttpAdapter } from "./HttpAdapter";
import type { Request, Response } from "express";

/**
 * Adapter for converting between Express Request/Response and IHttpRequest/IHttpResponse.
 *
 * This adapter handles the conversion of Express-specific request/response objects
 * to and from the framework-agnostic typeweaver types.
 */
export class ExpressAdapter extends HttpAdapter<Request, void> {
  /**
   * Converts an Express Request to an IHttpRequest.
   *
   * @param req - The Express request object
   * @returns Promise resolving to an IHttpRequest
   */
  public async toRequest(req: Request): Promise<IHttpRequest> {
    return {
      method: req.method.toUpperCase() as HttpMethod,
      path: req.path,
      header: this.extractHeaders(req.headers),
      query: this.extractQuery(req.query),
      param: this.extractParams(req.params),
      body: this.parseBody(req),
    };
  }

  /**
   * Not used for Express - use sendResponse instead.
   * Express uses a different pattern where the response is sent via res methods.
   *
   * @throws Error - Always throws, use sendResponse instead
   */
  public toResponse(): void {
    throw new Error("Use sendResponse instead for Express");
  }

  /**
   * Sends an IHttpResponse through the Express Response object.
   *
   * @param httpResponse - The IHttpResponse to send
   * @param res - The Express Response object
   */
  public sendResponse(httpResponse: IHttpResponse, res: Response): void {
    const { statusCode, body, header } = httpResponse;

    // Set headers
    if (header) {
      for (const [key, value] of Object.entries(header)) {
        if (value !== undefined) {
          if (Array.isArray(value)) {
            res.set(key, value);
          } else {
            res.set(key, String(value));
          }
        }
      }
    }

    // Set status code
    res.status(statusCode);

    // Send response body
    if (body === undefined) {
      res.end();
    } else if (typeof body === "string") {
      res.send(body);
    } else if (Buffer.isBuffer(body)) {
      res.send(body);
    } else {
      res.json(body);
    }
  }

  /**
   * Extracts headers from the Express request headers object.
   *
   * @param headers - The Express request headers
   * @returns IHttpHeader or undefined if no headers
   */
  private extractHeaders(headers: Request["headers"]): IHttpHeader | undefined {
    if (!headers) return undefined;

    const result: Record<string, string | string[]> = {};

    for (const [key, value] of Object.entries(headers)) {
      if (value !== undefined) {
        result[key] = value;
      }
    }

    return Object.keys(result).length > 0 ? result : undefined;
  }

  /**
   * Extracts query parameters from the Express request query object.
   *
   * @param query - The Express request query
   * @returns IHttpQuery or undefined if no query params
   */
  private extractQuery(query: Request["query"]): IHttpQuery | undefined {
    if (!query || Object.keys(query).length === 0) return undefined;

    const result: Record<string, string | string[]> = {};

    for (const [key, value] of Object.entries(query)) {
      if (typeof value === "string") {
        result[key] = value;
      } else if (Array.isArray(value)) {
        result[key] = value.filter((v): v is string => typeof v === "string");
      }
    }

    return Object.keys(result).length > 0 ? result : undefined;
  }

  /**
   * Extracts path parameters from the Express request params object.
   *
   * @param params - The Express request params
   * @returns Record of path parameters or undefined if none
   */
  private extractParams(
    params: Request["params"],
  ): Record<string, string> | undefined {
    if (!params || Object.keys(params).length === 0) return undefined;
    return params;
  }

  /**
   * Parses the request body from the Express request.
   * Note: Requires express.json() middleware to be set up.
   *
   * @param req - The Express request
   * @returns The parsed body or undefined
   */
  private parseBody(req: Request): IHttpBody | undefined {
    if (req.body !== undefined && Object.keys(req.body).length > 0) {
      return req.body as IHttpBody;
    }
    return undefined;
  }
}
