/* eslint-disable */
/**
 * This file was automatically generated by typeweaver.
 * DO NOT EDIT. Instead, modify the source definition file and generate again.
 * 
 * @generated by @rexeus/typeweaver
 */

import definition from "<%= sourcePath %>";
import { 
  type IHttpRequest,
  type SafeRequestValidationResult,
  RequestValidationError
} from "@rexeus/typeweaver-core";
import { RequestValidator } from "../lib/types";
import type { I<%= pascalCaseOperationId %>Request } from "<%= requestFile %>";

export class <%= pascalCaseOperationId %>RequestValidator extends RequestValidator {
    public safeValidate(request: IHttpRequest): SafeRequestValidationResult<I<%= pascalCaseOperationId %>Request> {
        const error = new RequestValidationError();
        const validatedRequest: IHttpRequest = {
            method: request.method,
            path: request.path,
            query: undefined,
            header: undefined,
            body: undefined,
            param: undefined,
        };

        <% if(body) { %>
            if (definition.request.body) {
                const result = definition.request.body.safeParse(request.body);
          
                if (!result.success) {
                  error.addBodyIssues(result.error.issues);
                } else {
                  validatedRequest.body = result.data;
                }
            }
        <% } %>

        <% if(header) { %>
            if (definition.request.header) {
                const coercedHeader = this.coerceHeaderToSchema(request.header, definition.request.header.shape);
                const result = definition.request.header.safeParse(coercedHeader);
          
                if (!result.success) {
                  error.addHeaderIssues(result.error.issues);
                } else {
                  validatedRequest.header = result.data;
                }
            }
        <% } %>

        <% if(param) { %>
            if (definition.request.param) {
                const result = definition.request.param.safeParse(request.param);
          
                if (!result.success) {
                  error.addPathParamIssues(result.error.issues);
                } else {
                  validatedRequest.param = result.data;
                }
            }
        <% } %>

        <% if(query) { %>
            if (definition.request.query) {
                const coercedQuery = this.coerceQueryToSchema(request.query, definition.request.query.shape);
                const result = definition.request.query.safeParse(coercedQuery);
          
                if (!result.success) {
                  error.addQueryIssues(result.error.issues);
                } else {
                  validatedRequest.query = result.data;
                }
            }
        <% } %>

        if (error.hasIssues()) {
            return {
              isValid: false,
              error,
            };
          }
      
          return {
            isValid: true,
            data: validatedRequest as I<%= pascalCaseOperationId %>Request,
          };
    }

    public validate(request: IHttpRequest): I<%= pascalCaseOperationId %>Request {
        const result = this.safeValidate(request);
    
        if (!result.isValid) {
          throw result.error;
        }
    
        return result.data;
      }
}